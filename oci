# azure-pipelines.yml
trigger:
  branches:
    include:
      - main

variables:
  # These should be set in pipeline variable group or pipeline variables securely
  GCP_PROJECT_ID: 'my-gcp-project'            # override in ADO pipeline variables
  GCP_REGION: 'asia-south1'
  IMAGE_REPO: 'cloudrun-images'
  IMAGE_NAME: 'oci-reports'
  TF_WORKING_DIR: 'infra/terraform/prod'

stages:
- stage: BuildAndDeploy
  jobs:
  - job: Build_Push_Terraform
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.11'
    - script: |
        echo "Setting up environment..."
        python -V
      displayName: 'Verify Python'

    # Fetch the GCP service account key from a secure pipeline variable (GCP_SA_KEY)
    # Recommended: store it in a secure file in library and use a pipeline secret variable containing the JSON.
    - bash: |
        echo "Writing GCP service account key to file..."
        echo '$(GCP_SA_KEY)' > /tmp/gcp-key.json
        export GOOGLE_APPLICATION_CREDENTIALS="/tmp/gcp-key.json"
        gcloud --quiet auth activate-service-account --key-file="$GOOGLE_APPLICATION_CREDENTIALS"
        gcloud config set project ${GCP_PROJECT_ID}
      env:
        GCP_PROJECT_ID: $(GCP_PROJECT_ID)
      displayName: 'Authenticate to GCP'

    - bash: |
        # Configure docker for artifact registry
        REGION=${GCP_REGION}
        REPO=${IMAGE_REPO}
        IMAGE=${IMAGE_NAME}
        TAG=$(Build.SourceVersion)
        FULL_IMAGE="${REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/${REPO}/${IMAGE}:${TAG}"
        echo "FULL_IMAGE=$FULL_IMAGE" > image.env
        # enable required APIs if not enabled (optional)
        gcloud services enable artifactregistry.googleapis.com --project=${GCP_PROJECT_ID}
        # create docker repo if not exists - can be handled by terraform as well
        # Build and push
        docker --version
        gcloud auth configure-docker ${GCP_REGION}-docker.pkg.dev --quiet
        docker build -f infra/docker/Dockerfile -t ${FULL_IMAGE} .
        docker push ${FULL_IMAGE}
      displayName: 'Build and Push Docker image'

    - script: |
        # pass the image path into tfvars or env var used by terraform
        source image.env
        IMAGE_TAG=$(cat image.env | sed -n 's/^FULL_IMAGE=//p')
        echo "Image built: $IMAGE_TAG"
        # set TF env var for provider auth
        export GOOGLE_APPLICATION_CREDENTIALS="/tmp/gcp-key.json"
        cd ${TF_WORKING_DIR}
        terraform init -input=false
        terraform plan -input=false -out=tfplan -var="project_id=${GCP_PROJECT_ID}" -var="container_image=${IMAGE_TAG}" -var="terraform_state_bucket=${TF_STATE_BUCKET}"
        terraform apply -input=false -auto-approve tfplan
      env:
        TF_STATE_BUCKET: $(TF_STATE_BUCKET)   # set in pipeline variables (existing state bucket)
      displayName: 'Terraform Init/Plan/Apply'
